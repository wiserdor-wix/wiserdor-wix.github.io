function getViewportSize(){var e=document.documentElement;return{width:e.clientWidth,height:e.clientHeight}}!function(e){var t=getViewportSize().width,i=getViewportSize().height;$.fn.pageFlipper=function(e){function a(){N={top:z.pageHeight,left:2*z.pageWidth},X={top:z.pageHeight,left:2*z.pageWidth},B=!1}function o(e){R=$("<div id='canvasHolder'></div>"),R.insertAfter(e).addClass(z.className).attr("width",2*z.pageWidth).attr("height",z.pageHeight+2*z.pageHeightOffset),P=$("<canvas id='mainCanvas'></canvas>"),R.append(P),P.attr("width",2*z.pageWidth).attr("height",z.pageHeight+2*z.pageHeightOffset),L=$("<canvas id='tempCanvas'></canvas>"),L.css({position:"absolute",top:P.position().top,left:P.position().left}).attr("width",P.width()).attr("height",P.height()).appendTo(R),G=P.get(0).getContext("2d"),I=L.get(0).getContext("2d"),G.strokeStyle="#aaaaaa",G.beginPath(),G.moveTo(z.pageWidth,z.pageHeightOffset),G.lineTo(z.pageWidth,z.pageHeight+z.pageHeightOffset),G.stroke()}function p(){$(L).bind("mousemove",s).bind("mouseout",d).bind("mousedown",r).bind("touchstart",r),$(document).bind("mousemove",function(e){U=!1,A||q&&(N={left:e.pageX-$(R).position().left,top:e.pageY-z.pageHeightOffset+70})}).bind("touchmove",function(e){if(U=!1,!A&&q&&null!=e.originalEvent&&1==e.originalEvent.touches.length){e.preventDefault();var t=e.originalEvent.touches[0];N={left:t.screenX-$(R).position().left,top:t.screenY-z.pageHeightOffset+70}}}).bind("mousedown",function(e){(e.pageX<R.position().left||e.pageX>R.position().left+R.width()||e.pageY<R.position().top+z.pageHeightOffset||e.pageY>R.position().top+R.height()-z.pageHeightOffset)&&(J=!0)}).bind("mouseup",l).bind("touchend",l)}function g(){I.clearRect(0,0,L.width(),L.height())}function n(){(A&&(f(),g(),v()),B?0==Z:Z==Q-2)||(B?Z>0:Z<Q-2)&&(N={top:z.pageHeight,left:B?2*z.pageWidth:0},X={left:B?1:2*z.pageWidth-1,top:z.pageHeight-1},A=!0,D=h(B))}function h(e){return function(){Z+=e?-2:2,N={left:e?0:2*z.pageWidth,top:z.pageHeight},X=N,m(),g(),q=!1,z.pageFlipCallback&&z.pageFlipCallback(Z)}}function l(e){if(!J){if(U)return void n();if(!A){if(q=!1,B?0==Z:Z==Q-2)return;var t=e.pageX-$(R).position().left;(B?t>z.pageWidth:t<z.pageWidth)?(N={left:B?z.spreadWidth:0,top:z.pageHeight},A=!0,D=h(B)):N={left:B?z.cornerSide:z.spreadWidth-z.cornerSide,top:z.pageHeight-z.cornerSide}}}}function r(e){if(U=!0,J=!1,!A){var t=$(R).position(),i={top:e.pageY-t.top-z.pageHeightOffset,left:e.pageX-t.left};i.top>=0&&i.top<z.pageHeight&&(i.left>=0&&i.left<z.pageWidth?(N={left:z.cornerSide,top:z.pageHeight-z.cornerSide},B||(B=!0,X={left:0,top:z.pageHeight})):i.left>=z.pageWidth&&i.left<z.spreadWidth?(N={left:z.spreadWidth-z.cornerSide,top:z.pageHeight-z.cornerSide},B&&(B=!1,X={left:z.spreadWidth,top:z.pageHeight})):N={left:B?0:z.spreadWidth,top:z.pageHeight},e.preventDefault(),q=!0)}}function d(e){q||A||(N={left:B?0:z.spreadWidth,top:z.pageHeight})}function s(e){if(U=!1,!q&&!A){var t=$(R).position(),i={top:e.pageY-t.top-z.pageHeightOffset,left:e.pageX-t.left};i.top>=0&&i.top<z.pageHeight?i.left>=0&&i.left<z.pageWidth?(N={left:z.cornerSide,top:z.pageHeight-z.cornerSide},B||(B=!0,X={left:0,top:z.pageHeight})):i.left>=z.pageWidth&&i.left<z.spreadWidth?(N={left:z.spreadWidth-z.cornerSide,top:z.pageHeight-z.cornerSide},B&&(B=!1,X={left:z.spreadWidth,top:z.pageHeight})):N={left:B?0:z.spreadWidth,top:z.pageHeight}:N={left:B?0:z.spreadWidth,top:z.pageHeight}}}function f(){null!=D&&(D(),D=null),A=!1}function c(){if(null!=N){var e=(N.top-X.top)*z.easing,t=(N.left-X.left)*z.easing;if(t=Math.abs(t)<.5?0:t,e=Math.abs(e)<.5?0:e,0==t&&0==e)return void f();X.top+=e,X.left+=t;var i,a,o=X.left-z.pageWidth,p=E-X.top,g=Math.atan2(p,o),n=Math.cos(g)*z.pageWidth+z.pageWidth,h=E-Math.sin(g)*z.pageWidth,l=Math.sqrt((E-X.top)*(E-X.top)+(X.left-z.pageWidth)*(X.left-z.pageWidth)),r=Math.sqrt((E-h)*(E-h)+(n-z.pageWidth)*(n-z.pageWidth));r<l?(i=n,a=h):(i=X.left,a=X.top),o=V-i,p=a,l=Math.sqrt(o*o+p*p);var d=Math.atan2(p,o);if(l>z.pageDiagonal){var s=-Math.cos(d)*z.pageDiagonal+z.pageWidth,c=Y+Math.sin(d)*z.pageDiagonal;i=s,a=c}var H=B?i/2:(2*z.pageWidth-i)/2+i,v=(z.pageHeight-a)/2+a,W=Math.atan2(z.pageHeight-v,B?H:2*z.pageWidth-H),m=Math.tan(W)*(z.pageHeight-v),y=H+m*(B?1:-1);y<0&&(y=0);var C=F-a,w=y-i;_=B?Math.atan2(-C,-w):Math.atan2(C,w);var b=i+z.pageWidth/2*Math.cos(_)*(B?-1:1)+z.pageHeight/2*Math.sin(_),k=a-z.pageHeight/2*Math.cos(_)+z.pageWidth/2*Math.sin(_)*(B?-1:1),S=Math.atan2(z.pageHeight-v,H-y),O=S/Math.abs(S)*90-180*S/Math.PI;O=O/180*Math.PI;var M=F-v,$=H-y,x=y*v-H*F,T=-($*z.pageHeight/2+x)/M,D=z.pageClipWidth/2/Math.cos(O),P=T+D*(B?1:-1),L=z.pageHeight/2;u(b,k,_,P,L,O,P+(B?3*-D:D))}}function u(e,t,i,a,o,p,g){I.clearRect(0,0,L.width(),L.height()),I.save(),I.translate(a,o+z.pageHeightOffset),I.rotate(p),I.beginPath(),I.rect(-z.pageClipWidth/2,-z.pageClipHeight/2,z.pageClipWidth,z.pageClipHeight),I.clip(),I.rotate(-p),I.translate(-a,-o-z.pageHeightOffset),I.translate(e,t+z.pageHeightOffset),I.rotate(i),y(I,M(),-z.pageWidth/2,-z.pageHeight/2),I.restore(),I.save(),I.translate(g,o+z.pageHeightOffset),I.rotate(p),I.beginPath(),I.rect(0,-z.pageDiagonal,z.pageClipWidth,z.pageClipHeight),I.clip(),I.rotate(-p),I.translate(-g,-o-z.pageHeightOffset),I.translate(0,0),y(I,x(),B?0:z.pageWidth,z.pageHeightOffset),I.restore()}function H(){var e=function(){v(),setTimeout(e,z.updateDelay)};e()}function v(){c()}function W(e){o(e),a(),p(),H(),C();var t=$("div.content li img",e);Q=t.length+2;for(var i=0;i<t.length;i++)K[i]=j,b(t,i);t.length%2==1&&(K.push(j),Q++),m()}function m(){var e=S(),t=O();null!=e?(z.shadow&&(G.shadowBlur=z.shadow.blur,G.shadowColor=z.shadow.color,G.clearRect(0,z.pageHeightOffset+z.pageHeight,2*z.pageWidth,z.pageHeightOffset),G.clearRect(0,0,2*z.pageWidth,z.pageHeightOffset)),y(G,e,0,z.pageHeightOffset),z.nonSolidBackground&&"background"==e.type&&G.clearRect(0,0,z.pageWidth,z.pageHeight+2*z.pageHeightOffset)):G.clearRect(0,z.pageHeightOffset,z.pageWidth,z.pageHeight),null!=t?(y(G,t,z.pageWidth,z.pageHeightOffset),z.nonSolidBackground&&"background"==t.type&&G.clearRect(z.pageWidth,0,z.pageWidth,z.pageHeight+2*z.pageHeightOffset)):G.clearRect(z.pageWidth,z.pageHeightOffset,z.pageWidth,z.pageHeight)}function y(e,t,i,a){null!=t&&null!=t.type&&t.type.length>0&&("image"==t.type&&null!=t.data?t.isLoaded&&e.drawImage(t.data,i,a):"background"==t.type&&(e.fillStyle=z.backgroundColor,e.fillRect(i,a,z.pageWidth,z.pageHeight)))}function C(){var e=$("<canvas></canvas>");e.attr("width",z.pageWidth).attr("height",z.pageHeight);var t=e[0].getContext("2d");t.fillStyle=z.defaultPageColor,t.fillRect(0,0,z.pageWidth,z.pageHeight);var i=new Image;i.onload=function(){j.isLoaded=!0},i.src=e[0].toDataURL(),j={type:"image",data:i,isLoaded:!1}}function w(e){return 0==e||e==Q-1?{type:"background"}:K[e-1]}function b(e,t){k($(e[t]).attr("src"),function(e){K[t]={type:"image",data:e,isLoaded:!0},t!=Z&&t!=Z+1||m()})}function k(e,t){var i=new Image;i.onload=function(){t(i)},i.src=e}function S(){return w(Z)}function O(){return w(Z+1)}function M(){return w(B?Z-1:Z+2)}function x(){return w(B?Z-2:Z+3)}console.log("FlipperStart");var T={className:"canvasHolder",pageWidth:t/2-10,pageHeight:i-10-40,easing:.5,fps:20,defaultPageColor:"green",backgroundColor:"green",cornerSide:50},z=$.extend(T,e);z.updateDelay=1e3/z.fps,z.spreadWidth=2*z.pageWidth,z.pageDiagonal=Math.sqrt(z.pageWidth*z.pageWidth+z.pageHeight*z.pageHeight),z.pageClipWidth=z.pageWidth,z.pageClipHeight=10*z.pageWidth,z.pageHeightOffset=20;var B,D,P=null,L=null,R=null,G=null,I=null,N=null,X=null,_=0,V=z.pageWidth,Y=0,E=z.pageHeight,F=z.pageHeight,q=!1,A=!1,J=!1,U=!1,j=null,Q=0,K=[],Z=0;return this.getImageIndex=function(){return Z},this.nextPage=function(){B=!1,n()},this.prevPage=function(){B=!0,n()},this.goToPage=function(e){e>Z?(Z=e-2,this.nextPage()):e<Z&&(Z=e+2,this.prevPage())},this.each(function(){W(this)})}}(jQuery),console.log("App loaded");var BookGalleryController=function(e,t){var i=this;i.itemClass="item",i.itemSelector="."+i.itemClass,i.items=[],i.props={},this.resize=_.debounce(_.bind(this._resize,this),200),BookGalleryController.super_.apply(this,arguments),$(i.el).on("click",".page",function(e){})};utils.inherits(BookGalleryController,SimpleAppProto),BookGalleryController.prototype.updateLayout=function(){console.log("updateLayout"),$("#imagesList").pageFlipper({fps:20,easing:.15,backgroundColor:"black"}),$("#mouse").css({width:"20px",height:"20px","-moz-border-radius":"10px","-webkit-border-radius":"10px"})},BookGalleryController.prototype.updateSettings=function(e){console.log("updateSettings");var t=this,i=!1;t.itemsChanged(e.items,["uri"])?i=!0:t.propsChanged(e.props,["flipOrientation"])&&(i=!0),i?(t.destroy(),t.items=e.items||[],t.props=e.props||{},t.createDom()):_.extend(t.props,e.props),$(t.el).css("text-align",t.props.alignText),t.updateLayout()},BookGalleryController.prototype.createDom=function(){console.log("createDom");var e=this,t=e.getViewportSize();e.el.html(""),e.displayNode=$('<div id="container"></div>').appendTo(this.el);var i=$('<ul id="imagesList"></ul>').appendTo(e.displayNode),a={height:Math.floor(t.height-50),width:Math.floor(t.width/2)};console.log(a.width,a.height),_.each(this.items,function(t,o){var p=utils.getResizedImageUrl(t.uri,a.width,a.height),g=$('<div class="content"><li><img src="'+p+'"></li></div>').appendTo(i);g.data("item",t).addClass(e.itemClass),$('<div class="flip"></div>').appendTo(g);var n=$('<div class="details"></div>').appendTo(g).addClass("hide");$('<h3 class="title"></h3>').appendTo(n).html(t.title).addClass("hide")}),$('<div class="shadow"></div>').appendTo(e.displayNode).css("left",t.width/2-85).css("height",t.height)},BookGalleryController.prototype.itemClick=function(e,t,i){var a=this;switch(a.props.galleryImageOnClickAction){case"goToLink":a.openLink(e.href,i.target,e.linkType,i,void 0,void 0,e.link);break;case"zoomMode":Wix.pushState(JSON.stringify({cmd:"zoom",args:[t]}));break;case"disabled":default:Wix.pushState(JSON.stringify({cmd:"itemClicked",args:[t]}))}},BookGalleryController.prototype._resize=function(){console.log("resize");var e=this,t=e.getViewportSize();$(e.el).width(t.width).height(t.height)},BookGalleryController.prototype.getViewportSize=function(){var e=document.documentElement;return{width:e.clientWidth,height:e.clientHeight}},BookGalleryController.prototype.destroy=function(){this.el.html("")};